<!doctype html>
<title>Testing grounds</title>
<meta charset=utf8>
<style>
table {
    width: 100%;
}
table th {
    text-align: center;
    padding-top: 1em;
}
table td.winner {
    font-weight: bold;
}
</style>
<script>

function decide_winner_loser_class(name, match)
{
    var has_winner = match[2] > match[3] || match[3] > match[2];
    if (has_winner) {
        var winner = match[2] > match[3] ? match[0] : match[1];
        if (winner == name)
            return "winner";
        else
            return "loser";
    } else {
        return "tie"
    }
}

function make_link(name) {
    return "<a href=\"?" + encodeURIComponent(name) + "\">" + name + "</a>";
}

function req(url, fun, params) {
    var http = new XMLHttpRequest();
    http.open(params ? "POST" : "GET", url, true);
    http.responseType = 'json';
    http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    http.onreadystatechange = fun;
    http.send(params);
}

function handle_match(match, division, query, traversal) {
    console.log(match[0], query.player);
    if (match[0] == query.player || match[1] == query.player)
        traversal.handle_match(match, division);
}

function walk_matches(round, query, traversal) {
    for (match of round[1]["games"]) {
        handle_match(match, round[0], query, traversal);
    }
}

function walk_rounds(data, query, traversal) {
    for (round of data[1].sort()) {
        walk_matches(round, query, traversal);
    }
}
// = decodeURIComponent(document.location.substr(1).split('/')[0]);
var player_name = decodeURIComponent(document.location.search.substr(1));
query = { player: player_name };

req("http://localhost/squash/load.cgi?player=" + encodeURIComponent(query.player), function(e) {
    table_strings = []
    current_division = "";
    if (this.readyState == 4 && this.status == 200) {
        walk_rounds(this.response, query, {
            handle_match: function(match, division) {
                if (division != current_division) {
                    table_strings.push("<tr><th colspan=7>" + division);
                    current_division = division;
                }

                table_strings.push("<tr><td class=" + decide_winner_loser_class(match[0], match) + ">" + make_link(match[0]) +
                                   "<td class=" + decide_winner_loser_class(match[1], match) + ">" + make_link(match[1]) + "<td>" + match[2] + "<td>" + match[3]);

                if (match.length == 4)
                    table_strings.push("<td colspan=3>");
                else if (match.length == 7)
                    table_strings.push("<td>" + match[4] + "<td>" + match[5] + "<td>" + match[6]);
            }
        });
        var table = document.createElement('table');
        table.innerHTML = table_strings.join("");
        document.body.appendChild(table);
    }
});


</script>
