<!DOCTYPE html>
<title>Squash ladder</title>
<meta charset=utf8>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {
    margin: 0 auto;
    font-family: lato, Tahoma, sans-serif;
    box-sizing: border-box;
}
#error {
    color: red;
    font-weight: bold;
    text-align: center;
    background-color: pink;
}
table {
    width: 100%;
    border-collapse: collapse;
}
td, th {
    padding: 0.5em;
}
#results tr:nth-child(3), #results tr:nth-child(5) {
    border-bottom: 1px dashed grey;
}
.uibar {
    text-align: center;
    font-weight: bold;
    margin: 1em;
}
button { flex: 0 0 auto; }
label { margin: 0.3em;}
input[type=button] {
    padding: 1em;
    color: white;
    border-radius: 0.5em;
    border: none;
    font-weight: bold;
    float: right;
    display: block;
    width: 10em;
    margin: 1em;
}
#resultswrapper {
    background-color: #222;
    background-image: repeating-linear-gradient(
        135deg,
        rgba(255,255,255,.02),
        rgba(255,255,255,.02) 10px,
        transparent 10px,
        transparent 20px
    );
    color: white;
    border-bottom: 10px solid #568;
    min-height: 22em; /* Guesstimate */
}
#results, .ui {
    max-width: 60em;
    margin: 0 auto;
    padding: 0.4em;
}
td input {
    text-align: right;
    border: 1px dashed lightgrey;
    padding: 0.2em;
}
.downloadcsv {
    margin: 1em;
    float: left;
    font-style: italic;
}
input.p1, input.p2 {
    width: 1em;
}
.uiarea h2 {
    text-align: center;
}
footer {
    margin: 1em;
    float: right;
}
</style>
<div id="resultswrapper"><div id="results"></div></div>
<div id="error"></div>
<div class="ui">
    <div class="uibar">
	<label>År</label><select id="yearselection"></select>
        <label>Omgång</label><select id="roundselection"></select>
        <label>Division</label><select id="divisionselection"></select>
    </div>
    <div class="uiarea"></div>
    <footer><a href="dump.cgi" download>Ladda ner databas</a></footer>
</div>
<script>
var csv = function() {
    'use strict';

    var calendarEvents = [];
    var calendarStart = [
	"Subject",
	"Start Date",
	"Start Time",
	"End Date",
	"End Time",
	"All Day Event",
	"Description",
	"Location"].join(',');

    var saveData = (function () {
        var a = document.createElement("a");
        document.body.appendChild(a);
        a.style = "display: none";
        return function (data, fileName) {
            var blob = new Blob([data], {type: "octet/stream"}),
                url = window.URL.createObjectURL(blob);
            a.href = url;
            a.download = fileName;
            a.click();
            window.URL.revokeObjectURL(url);
        };
    }());

    return {
        'addEvent': function(subject, description, location, begin, stop) {
            //TODO add time and time zone? use moment to format?
            var start_date = begin;
            var end_date = stop;

            var start_year = ("0000" + (start_date.getFullYear().toString())).slice(-4);
            var start_month = ("00" + ((start_date.getMonth() + 1).toString())).slice(-2);
            var start_day = ("00" + ((start_date.getDate()).toString())).slice(-2);
            var start_hours = ("00" + (start_date.getHours().toString())).slice(-2);
            var start_minutes = ("00" + (start_date.getMinutes().toString())).slice(-2);
            var start_seconds = ("00" + (start_date.getSeconds().toString())).slice(-2);

            var end_year = ("0000" + (end_date.getFullYear().toString())).slice(-4);
            var end_month = ("00" + ((end_date.getMonth() + 1).toString())).slice(-2);
            var end_day = ("00" + ((end_date.getDate()).toString())).slice(-2);
            var end_hours = ("00" + (end_date.getHours().toString())).slice(-2);
            var end_minutes = ("00" + (end_date.getMinutes().toString())).slice(-2);
            var end_seconds = ("00" + (end_date.getSeconds().toString())).slice(-2);

            var start = start_year + start_month + start_day + start_time;
            var end = end_year + end_month + end_day + end_time;

	    var start_time = [ start_hours, start_minutes, start_seconds ].join(':');
            var end_time = [ end_hours, end_minutes, end_seconds ].join(':');

            var calendarEvent = [
		subject,
		[ start_year, start_month, start_day].join("-"),
		start_time,
		[ end_year, end_month, end_day ].join("-"),
		end_time,
		'False',
		description,
		location
            ].join(',');
            calendarEvents.push(calendarEvent);
            return calendarEvent;
        },

        'download': function(filename, ext) {
            if (calendarEvents.length < 1) {
                return false;
            }

            var a = document.createElement("a");
            document.body.appendChild(a);
            a.style = "display: none";

            ext = (typeof ext !== 'undefined') ? ext : '.csv';
            filename = (typeof filename !== 'undefined') ? filename : 'calendar';
            var calendar = calendarStart + '\n' + calendarEvents.join('\n');
            saveData(calendar, filename + ext);
            return calendar;
        }
    };
};

function req(url, fun, params) {
    var http = new XMLHttpRequest();
    http.open(params ? "POST" : "GET", url, true);
    http.responseType = 'json';
    http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
    http.onreadystatechange = fun;
    http.send(params);
}

function addResults(results, scoreboard, exception) {
    var h1 = document.createElement('h1');
    h1.textContent = scoreboard.shift();

    var span = document.createElement('span');
    span.style = "font-size: smaller; float:right";
    span.textContent = scoreboard.shift();
    h1.appendChild(span);

    results.appendChild(h1);


    var table = document.createElement('table');
    table.id = "results";
    var tablestring = "<tr><th>Namn<th>S<th>V<th>F<th>P";
    for (var score of scoreboard)
	tablestring += "<tr><td>" + score.join("<td>");
    table.innerHTML = tablestring;
    results.appendChild(table);
}

function updateResult(p1result, p2result, p1points, p2points) {
    p1result.points += p1points;
    p1result.nentries++;
    p2result.points += p2points;
    p2result.nentries++;
    if (p1result > p2result) {
	p2result.lost++;
	p1result.won++;
    } else if (p1result < p2result){
	p1result.lost++;
	p2result.won++;
    }
}

function computeResults(round) {
    var result = {};

    if (!round.hasOwnProperty('players'))
	throw "'players' array missing";

    // Reset values
    for (var player of round.players) {
	if (result.hasOwnProperty(player))
            throw "Duplicate player name: " + player;

	result[player] = { nentries: 0, points: 0, won: 0, lost: 0 };
    }

    if (!round.hasOwnProperty('games'))
	throw "'games' array missing";

    // Score played games into results.

    for (var game of round.games) {
	if (game.length < 4)
            throw "Match med för få fält";

	var name1 = game[0],
            name2 = game[1],
            result1 = game[2],
            result2 = game[3];

	if (result[name1] === undefined)
            throw "Spelare " + name1 + " är okänd";

	if (result[name2] === undefined)
            throw "Spelare " + name2 + " är okänd";

	if (result[name1] === result[name2])
            throw "Spelare " + name1 + " kan inte spela mot sig själv";

	if (result1 == 'W') {
	    updateResult(result[name1], result[name2], -2, 4);
	} else if (result2 == 'W') {
	    updateResult(result[name1], result[name2], 4, -2);
	} else if (result1 > 0 || result2 > 0) {
            if (result1 < 0 || result1 > 3)
		throw "Resultat '" + result1 + "' är ogiltigt";
            if (result2 < 0 || result2 > 3)
		throw "Resultat '" + result2 + "' är ogiltigt";
            if (result1 + result2 > 5)
		throw "Resultat '" + result1 + "-" + result2 + "' är ogiltigt";

            // First award each player with one point for participating.
            var p1points = 1;
            var p2points = 1;

            // Give points for each won set.
            p1points += result1;
            p2points += result2;

            // Give an extra point to the winner.
            if (result1 == 3) {
		p1points++;
		result[name2].lost++;
		result[name1].won++;
            } else if (result2 == 3) {
		p2points++;
		result[name1].lost++;
		result[name2].won++;
            }
	    updateResult(result[name1], result[name2], p1points, p2points);
	}
    }

    // Now convert results into a sorted list of results.

    var arr = [];

    for (var name in result)
	arr.push([name, result[name].nentries, result[name].won, result[name].lost, result[name].points]);

    arr.sort(function(a, b) {
	var points1 = a[4];
	var points2 = b[4];
	if (points1 == points2) {
            for (var game of round.games) {
		var name1 = game[0],
                    name2 = game[1],
                    result1 = game[2],
                    result2 = game[3];

		if ((name1 == a[0] && name2 == b[0]) ||
                    (name1 == b[0] && name2 == a[0]))
                    return result2 - result1;
            }
            // No played games between them. What to do?
            console.log("Warning: could not break tie between " + a[0] + " and " + b[0] + " without Math.random()");
            return Math.random() - 0.5;
	} else {
            return points2 - points1;
	}
    });

    var namearr = parse_division_name(division_name);
    if (namearr) {
        arr.unshift(namearr[0] + "#" + namearr[1]);
        arr.unshift(namearr[2]);
    }

    return arr;
}

var yearselect = document.querySelector('#yearselection');
var roundselect = document.querySelector('#roundselection');
var divisionselect = document.querySelector('#divisionselection');
var errorblock = document.querySelector('#error');

var results = document.querySelector('#results');
var division_name = document.location.hash.substr(1);

var currenthash = ""; // current object we're working on
var parenthash = "";
var round = {};

function save() {
    if (!division_name)
	return;
    req("save.cgi",
	function() {
            if (this.readyState == 4 && this.status == 200) {
                if (this.response)
		    currenthash = this.response[0];
                else
	            errorblock.innerHTML = "Kunde inte spara!";
            }
	}, "division=" + encodeURIComponent(division_name) + "&parent=" +
           encodeURIComponent(currenthash) + "&data=" + encodeURIComponent(JSON.stringify(round)));
}

function build_scoreboard() {
    results.innerHTML = "";
    errorblock.innerHTML = "";

    try {
	addResults(results, computeResults(round));
    } catch (e) {
	errorblock.innerHTML = e;
    }
}

function on_round_changed() {
    errorblock.innerHTML = "";

    if (round == {}) {
	errorblock.innerHTML = '<i>Empty round</i>';
	return;
    }

    build_ui_area();
    build_scoreboard();
}

function option(value, selected) {
    var x = document.createElement('option');
    x.text = value;
    if (value == selected)
	x.selected = true;
    return x;
}

function parse_division_name(division_name) {
    var re = /(\d\d\d\d)-r(\d+)-d(\d+)/;
    var found = division_name.match(re);
    if (found)
	return found.slice(1,4);
    else
	return null;
}

var years = {};

function updateList() {
    var requested_year = division_name ? parse_division_name(division_name)[0] : 0;
    req("list.cgi",
	function() {
            if (this.readyState == 4 && this.status == 200) {
		years = {};

		var existing = false;
		for (var iter of this.response) {
                    var res = parse_division_name(iter);
                    if (res) {
			if (!years[res[0]])
                            years[res[0]] = { };
			if (!years[res[0]][res[1]])
                            years[res[0]][res[1]] = [];
			years[res[0]][res[1]].push(res[2]);
                    }
		}

		for (var year of Object.keys(years)) {
                    yearselect.add(option(year, requested_year));
		}

		update_roundnr();
            }
	});
}

function update_roundnr(event) {
    var requested_roundnr = division_name ? parse_division_name(division_name)[1] : 0;
    roundselect.innerHTML = '';
    for (var round of Object.keys(years[yearselect.value])) {
	roundselect.add(option(round, requested_roundnr));
    }
    if (!division_name)
        roundselect.options[roundselect.options.length - 1].selected = true;
    update_divisionnr(event);
}

function update_divisionnr(event) {
    var requested_divisionnr = division_name ? parse_division_name(division_name)[2] : 0;
    divisionselect.innerHTML = '';
    for (var divisionnr of years[yearselect.value][roundselect.value].sort(function(a,b){return a - b})) {
	divisionselect.add(option(divisionnr, requested_divisionnr));
    }
    update_round(event);
}

function update_round(event) {
    if (event || !division_name) {
        division_name = yearselect.value + "-r" + roundselect.value + "-d" + divisionselect.value;
        document.location.hash = division_name;

        load_round();
    }
}

function load_round() {
    req("load.cgi?division=" + division_name,
	function() {
            if (this.readyState == 4 && this.status == 200) {
		try {
                    round = JSON.parse(this.response[4]);
                    currenthash = this.response[0];
                    on_round_changed();
		} catch (e) {
                    errorblock.innerHTML = e;
                    throw(e);
		}
            }
	});
}

function build_ui_area() {
    var uiarea = document.querySelector('.uiarea');
    uiarea.innerHTML = '';

    var table = document.createElement('table');

    round.games.forEach(function(game, i) {
        if (i % 3 == 0) {
            var header = document.createElement('h2');
            header.textContent = ((game[4] || "???") + " " + (game[5] || "???"));

            var tr = document.createElement('tr');
            var td = document.createElement('td');
            td.appendChild(header);
            td.colSpan = 5;
            tr.appendChild(td);
            table.appendChild(tr);
        }

	var tr = document.createElement('tr');
	tr.setAttribute("data-game-idx", i);

	var tablestring = `<td>${game[0]}<td>${game[1]}<td>Bana ${game[6] || "?"}<td><input class="p1" size=2 value=${game[2]}><td><input class="p2" size=2 value=${game[3]}>`;

	tr.innerHTML = tablestring;

	tr.querySelector('input.p1').onchange = function () {
            var gameidx = this.parentNode.parentNode.getAttribute("data-game-idx");
	    if (this.value == 'W')
		round.games[gameidx][2] = 'W';
	    else
		round.games[gameidx][2] = parseInt(this.value);
            build_scoreboard();
            save();
	};

	tr.querySelector('input.p2').onchange = function () {
            var gameidx = this.parentNode.parentNode.getAttribute("data-game-idx");
	    if (this.value == 'W')
		round.games[gameidx][3] = 'W';
	    else
		round.games[gameidx][3] = parseInt(this.value);
            build_scoreboard();
	};
	table.appendChild(tr);
    });
    uiarea.appendChild(table);

    var div = document.createElement('div');
    div.className = "downloadcsv";
    div.textContent = "Ladda ner .csv-fil: ";
    var select = document.createElement('select');
    var option = document.createElement('option');
    option.textContent = "---";
    select.appendChild(option);
    round.players.forEach(function(player) {
	var option = document.createElement('option');
        option.textContent = player;
        select.appendChild(option);
    });

    select.onchange = function (event) {
        var player = event.target.value;
        if (player == "---")
            return;
	var cal = csv();
	round.games.forEach(function(game, i) {
	    if (game[0] == player || game[1] == player) {
		var date = game[4].replace("-", "/");
		var begin = new Date(date + " " + game[5] + ":00");
		var end = new Date(begin.getTime());
		end.setMinutes(begin.getMinutes() + 45);
		cal.addEvent(`${game[0]} - ${game[1]}`,
			     `${game[0]} - ${game[1]} på bana ${game[6]}`,
			     'Landala Squashhall', begin, end);
	    }
	});
	cal.download(division_name + "_" + player.replace(/[^a-z0-9]/gi, '_').toLowerCase());
    };

    div.appendChild(select);
    uiarea.appendChild(div);
}

yearselect.onchange = update_roundnr;
roundselect.onchange = update_divisionnr;
divisionselect.onchange = update_round;

updateList();
if (division_name)
    load_round();
</script>
